#!/bin/bash

COUNT=8
CONFIG='$XDG_CONFIG_HOME/rndy/rndyrc'
RNDY_GPG=false

mkdir -p $XDG_CONFIG_HOME/rndy/domains $XDG_CONFIG_HOME/rndy/usernames

HELP=$(cat << 'EOF'
    Usage:
    rndy -d example.com -u username -c 8

    Options:
        -d  domain
        -u  username
        -c  count of symbols
        -o  output to console instead of clipboard
        -p  master password
        -f  configuration file
        -h  print this page
EOF
)

while getopts ":d:u:c:p:f:o" opt; do
    case $opt in
        #set domain name
        d)
            DOMAIN=$OPTARG
            ;;
        #set username
        u)
            USERNAME=$OPTARG
            ;;
        #set symbols count
        c)
            COUNT=$OPTARG
            ;;
        #set symbols' count
        p)
            MASTERPASSWORD=$OPTARG
            ;;
        #raw output or to xclipboard
        o)
            OUTPUT='RAW'
            ;;
        #set config
        f)
            CONFIG=$OPTARG
            ;;
        \?)
            echo "$HELP"
            exit 0
            ;;
    esac
done


touch $XDG_CONFIG_HOME/rndy/domains/$DOMAIN
touch $XDG_CONFIG_HOME/rndy/usernames/$USERNAME


if [[ $DOMAIN == "" ]]; then
    echo "$HELP"
    exit 1
fi


if [[ $CONFIG && -f $CONFIG ]]; then
    source $CONFIG
fi

if [[ $RNDY_GPG == true ]]; then
    MASTERPASSWORD=`gpg --batch --quiet -d $RNDY_PASSWORD_PATH `
fi

if [[ ! $MASTERPASSWORD ]]; then
    echo -n 'Type master-password: '
    read -s MASTERPASSWORD
    echo '' #new line for spliting prompt and password
fi

if [[ $MASTERPASSWORD == "" ]]; then
    echo 'Empty master password. Re-enter.'
    rm $HOME/.masterpassword
fi

PASSWORD=`echo -n $USERNAME$DOMAIN$MASTERPASSWORD | sha1sum | base64 | cut -c 1-$COUNT`

ISTHEREDIGITS=`echo -n $PASSWORD | grep -P '\d'`

if [[ ! $ISTHEREDIGITS ]]; then
    #replace first symbol with count nubmer
    PASSWORD=`echo $PASSWORD | sed 's/^./'$COUNT'/'`
fi

if [[ $OUTPUT ]]; then
    echo $PASSWORD
else
    echo -n $PASSWORD | xclip
fi
