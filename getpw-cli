#!/usr/bin/env python
# coding: utf-8

import sys
import getpass
import os
import getopt
import hashlib
import base64
import ConfigParser
if sys.platform == "linux2":
    import pygtk
    import gtk
if sys.platform == "darwin":
    import subprocess

configPath = os.environ["HOME"] + "/.pwget/config.ini"
pairsPath = os.environ["HOME"] + "/.pwget/pairs"
if os.path.exists(configPath):
    config = ConfigParser.ConfigParser()
    config.read(configPath)
if os.path.exists(pairsPath):
    passwords = ConfigParser.ConfigParser()
    passwords.read(pairsPath)

def pwget(username, domain, masterPassword):
    password = hashlib.sha1()
    password.update(username)
    password.update(domain)
    password.update(masterPassword)
    sha1hash = password.hexdigest()
    encodedHash = base64.b64encode(sha1hash)
    return encodedHash[:20]

def generatePairs(masterPassword):
    if config.has_section("sites"):
        output = ""
        for option in config.options("sites"):
            output += option + ": " + generatePass(masterPassword, option, config.get("sites", option)) + "\n"
        return output

def writePairs(pairs):
    pairsFile = open(pairsPath, "w+")
    pairsFile.write("[pairs]\n" + pairs)
    pairsFile.close()

def generatePass(masterPassword, domain, username):
    if domain:
        if username == "":
            if config.has_section("sites") and config.has_option("sites", domain):
                username = config.get("sites", domain)
        password = pwget(username, domain, masterPassword)
        return password
    else:
        usage()
        sys.exit()

def outputPassword(password, rawOutput):
    if rawOutput:
        print password
    else:
        try:
            clipboard = gtk.clipboard_get()
            clipboard.set_text(password)
            clipboard.store() # don't get why this is not working
            raw_input("Press `Enter` to continueâ€¦") # clipboard able to use when program is working
        except:
            #subprocess.call(["echo", password, "|", "pbcopy"])
            p1 = subprocess.Popen(["echo", password], stdout=subprocess.PIPE)
            p2 = subprocess.Popen(["pbcopy"], stdin=p1.stdout, stdout=subprocess.PIPE)
            p1.stdout.close()  # Allow p1 to receive a SIGPIPE if p2 exits.
            output = p2.communicate()[0]

def proceedFurther(domain, username, rawOutput, genPairs):
    if genPairs:
        masterPassword = getpass.getpass()
        writePairs(generatePairs(masterPassword))
    else:
        if domain and os.path.exists(pairsPath) and passwords.has_section("pairs") and passwords.has_option("pairs", domain):
            outputPassword(passwords.get("pairs", domain), rawOutput)
        else:
            masterPassword = getpass.getpass()
            outputPassword(generatePass(masterPassword, domain, username), rawOutput)

def usage():
    print "define username, domain name and master-password"

def main(argv):
    username = ""
    domain = ""
    rawOutput = 0
    genPairs = 0
    try:
        opts, args = getopt.gnu_getopt(argv, "hu:d:", ["help", "username", "domain", "raw-output", "generate-pairs"])
    except getopt.GetoptError:
        usage()
        sys.exit(2)
    for opt, arg in opts:
        if opt in ("-h", "--help"):
            usage()
            sys.exit()
        if opt in ("-u", "--username"):
            username = arg
        if opt in ("-d", "--domain"):
            domain = arg
        if opt in ("--raw-output"):
            rawOutput = 1
        if opt in ("--generate-pairs"):
            genPairs = 1
    if opts:
        proceedFurther(domain, username, rawOutput, genPairs)
    else:
        usage()
        sys.exit()

if __name__ == "__main__":
    main(sys.argv[1:])
